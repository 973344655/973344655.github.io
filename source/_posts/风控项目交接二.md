---
title: 风控项目交接说明二(失信人修复)
date: 2019-09-18 16:18:34
tags: [others]
---

现有项目地址: http://10.191.21.104:8300/unrepair/web/index

## 一.整体介绍

失信人修复主要分为三部分：

- 修复后验证(地理位置验证)

- 失信人修复

- 用户与菜单管理(门户控制)

## 二.具体情况

### 1.地理位置验证

#### 1.1 功能

输入手机号和地址，查询出用户号码所在城市，用户号码所在城市，输入地址与实际居住地址距离，等几个指标信息.<br>

这个没什么好说的，比较常规。

![addressVerify](http://67.216.218.49:8000/file/blogs/others/address_verify_01.png)

#### 1.2 注意点

1.经纬度的坐标系不是同一个坐标系，需要进行转化。

2.因为要调五个不同接口，最好不要串行，使用并发。因为返回值不一样，所以在控制好对应关系，处理时知道哪个结果是哪个接口的返回。

```
List<Future<Map<String,String>>> futures = new ArrayList<>();

futures.add(getAddress(jsonObject, permanentAddresss,"permanentAddress"));
futures.add(getAddress(jsonObject, cityName,"realTimeAddress"));
futures.add(getDistance2(jsonObject, workplaceVerification,"workDistance"));
futures.add(getDistance2(jsonObject, houseVerification,"houseDistance"));
futures.add(comparePosition(jsonObject, positionCompare,"positionCompare"));
```

### 2.失信人修复



![repair](http://67.216.218.49:8000/file/blogs/others/unrepair_repairType.png)

主要分为三种类型，三种类型分别有其对应的文件模板。

- 核验加修复

上传文件，核验，暂存或修复。

- 修复

上传文件，直接进行修复。

- 核验

上传文件，进行核验，将核验结果文件给用户，再决定是否进行修复。


这里主要讲一下 核验和修复这两块功能的逻辑。其它的上传下载，查询预览之类的常规功能就略过了。

#### 2.1 核验

##### 2.1.1 流程

用户根据类型，下载相应模板，然后上传需要核验的文件(只是一个文件)，后端进行简单的判断后，进行相应的数据补全， 然后调用核验接口，保存结果，并返回数据，同时生成结果文件供下载或进行下一步操作。<br>

核验结果分为四种情况，一致，不一致，调用错误，不存在号码， 只有不一致才进行修复。


##### 2.2.2 问题

核验接口为单条，文件可以1000条记录，所以耗时久，改为异步线程池后，一千条记录平均从70s降到了20s,依然有点慢。<br>
这里需要注意，不能太过增加线程池大小，一方面主机性能不一定够，另一方面，联通接口有QPS限制。

##### 2.2 修复

修复是电话号码和身份证不一致时，去联通，电信，或移动进行匹配，得到对应身份证下面的号码。

##### 版本一


- 单网

去联通查，每个身份证可以匹配多个号码，并对结果进行排序

- 三网

去三网查，但是不能马上得到返回结果。需要轮询。和张硕鹏讨论后，决定采用惰性轮询
,减少资源占用。<br>

这里接口需要得入参为json格式得txt文件，所以自己生成临时文件，并在请求时按照文件类型报文，手动构造Post文件的请求体。<br>

轮询得到的结果是一个外网文件地址。需要在代码中使用正向代理，获取文件，并对文件内容进行统计得到结果。

##### 版本二

不分为单网三网，而是分为联通，移动，电信 三种

- 联通

按照原先单网逻辑

- 电信

嵌入电信外呼页面，并提交数据

- 移动

嵌入移动外呼页面。并提交数据


问题：

嵌入的页面为 https, 然后所用证书多半为自己申请的免费证书，导致浏览器不信任<br>

接口文档未给，处理逻辑未给, 甲方与电信移动沟通中<br>


## 三.其它一些注意点

### 1.规范

方法注释，swagger等注释要完整<br>

返回消息用 ResultMessage 类型进行统一包装<br>

异常进行统一捕获处理,往前端抛友好提示，不抛异常 <br>

计次等日志类信息，统一用切面处理，不侵入代码<br>

用户管理相关功能，我们不操作门户的数据库，由门户自己进行处理，免得混杂.<br>

前端输入信息，要首先进行验证，避免多余消耗资源操作与安全问题， sql语句尽量用#{} 少用 ${} 防注入。<br>

多条操作，是否需要事务<br>

### 2.其它一些注意点

#### 2.1 缓存

修复接口需要用户信息，自己生成的token,或者用户新建时保存的token和endId等信息。
此类信息需进行全局缓存，在项目启动时生成并缓存. 同时提供惰性更新机制，当有新用户时，能自动更新添加新信息。

#### 2.2 跳转

原则上，后端不控制页面的跳转，但是为了解决初次登录门户在url后面加上jseesionid 导致的404问题，提供一个额外的跳转接口。

#### 2.3 环境切换问题

环境切换需要改两个文件，application.properties和bonc-security-base.properties

#### 2.4 部署分布式

部署分布式时，记得做文件共享，找丹姐

#### 2.5 特殊情况

如果核验过后，没有不一致的情况(即使有其它核验异常情况)， 再点修复，会返回无需要修复文件(甲方最初需求就这样)
