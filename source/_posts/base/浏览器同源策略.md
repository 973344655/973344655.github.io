---
title: 浏览器同源策略
date: 2019-10-14 21:16:55
tags: [base]
---

# 一.什么是同源策略

首先，同源策略是浏览器端的，不存在于安卓，ios,node或java等其他环境.

## 1.什么是同源

![origin](http://67.216.218.49:8000/file/blogs/base/origin_01.png)

即,协议,ip，port 共同构成源.

## 2.同源协议内容

- (1).不能读取非同源的Cookie,LocalStorage,IndexDB

- (2).不能获取非同源的DOM,Window

- (3).跨域AJAX请求返回不能接收，被浏览器拦截

## 3.一些可以跨域

- Form表单

form表单提交，一般会进行页面跳转

- \<image>,\<a>,\<script>,\<iframe>等拥有的src，href属性可以跨域

在127.0.0.1的地址的页面中，可以用iframe加载baidu.com的页面，但是不能读取baidu.com中的内容(window对象和document对象),但是如果加载自己域名下其他页面(同源)，是可以读取的




# 二.为什么

## 1.为什么需要同源策略

反证：如果没有同源策略会怎样?

如果没有同源策略，一个页面可以任意读取其它页面的信息(页面内容，cookie等)，不用说都知道这样肯定不行。会导致CSRF等.


# 三.怎么解决

## 1.JSONP

jsonp实现跨域是因为\<script>,所以，它也只能发get请求，毕竟从没见过post方式的\<script>

```
function addScriptTag(src) {  
  var script = document.createElement('script');  
  script.setAttribute("type","text/javascript");  
  script.src = src;  
  document.body.appendChild(script);  
}
window.onload = function () {  
  addScriptTag('http://example.com/ip?callback=foo');  
}
function foo(data) {  
  console.log('Your public IP address is: ' + data.ip);  
};
```

## 2.WebSocket

首先WebSocket是一个协议.WebSocket 可以由服务端主动向客户端推送消息，是双全工方式。<br>
而http，只能由客户端发起，是单向请求。<br>

具体可看:https://www.ruanyifeng.com/blog/2017/05/websocket.html

## 3.CORS

(原文) http://www.ruanyifeng.com/blog/2016/04/cors.html

Cross-origin resource sharing(跨域资源共享),是一个W3C标准，需要浏览器和服务器同时支持,目前浏览器都已支持，服务器端需进行配置.<br>

CORS请求分为简单请求和非简单请求。<br>

### 3.1 简单请求

#### 3.1.1 特征

 - 请求方式

 请求方式为 HEAD,GET,POST

 - header信息

 header信息不超出以下范围：
 ```
 Accept
 Accept-Language
 Content-Language
 Last-Event-ID
 Content-Type：
         application/x-www-form-urlencoded、 multipart/form-data、text/plain
 ```
 一般主要是看Content-Type, 比如Content-Type: application/json 为复杂请求



 #### 3.1.2 请求流程


 对于简单请求，浏览器直接发出CORS请求。具体来说，就是在头信息之中，增加一个Origin字段。
 如：
 ```
GET /cors HTTP/1.1
Origin: http://api.bob.com
Host: api.alice.com
Accept-Language: en-US
Connection: keep-alive
User-Agent: Mozilla/5.0...
 ```

 如果 Origin 不在许可的范围内，浏览器会返回一个正常的HTTP响应，但是响应头中不包含Access-Control-Allow-Origin信息，此时浏览器就知道出错了。

 如果 Origin 在许可的范围内，服务器返回会多出几个头信息。
 ```
Access-Control-Allow-Origin: http://api.bob.com
Access-Control-Allow-Credentials: true
Access-Control-Expose-Headers: FooBar
 ```

 ### 3.2 非简单请求

超出简单请求范围的请求。<br>

如请求方式为PUT,DELETE, header包含Cookie， Content-Type为 application/json 等。

非简单请求浏览器会先发送一个 OPTION 类型的预检请求，向服务器确认是否可以跨域。

```
OPTIONS /cors HTTP/1.1
Origin: http://api.bob.com
Access-Control-Request-Method: PUT
Access-Control-Request-Headers: X-Custom-Header
Host: api.alice.com
Accept-Language: en-US
Connection: keep-alive
User-Agent: Mozilla/5.0...
```

服务器收到预检请求后，检查Cors的相关信息，如果确认允许，则返回允许的信息，浏览器再发送真正请求，带上Origin字段。

```
HTTP/1.1 200 OK
Date: Mon, 01 Dec 2008 01:15:39 GMT
Server: Apache/2.0.61 (Unix)
Access-Control-Allow-Origin: http://api.bob.com
Access-Control-Allow-Methods: GET, POST, PUT
Access-Control-Allow-Headers: X-Custom-Header
Content-Type: text/html; charset=utf-8
Content-Encoding: gzip
Content-Length: 0
Keep-Alive: timeout=2, max=100
Connection: Keep-Alive
Content-Type: text/plain
```

```
PUT /cors HTTP/1.1
Origin: http://api.bob.com
Host: api.alice.com
X-Custom-Header: value
Accept-Language: en-US
Connection: keep-alive
User-Agent: Mozilla/5.0...
```

如果预检信息不通过，则服务器返回的不带Cors相关信息。
浏览器根据Cors相关信息来确定是否允许跨域。
